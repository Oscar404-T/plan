{% extends 'base.html' %}

{% block title %}排程结果 - 排程系统{% endblock %}

{% block page_title %}排程结果 - 订单 #{{ order.id }}{% endblock %}

{% block header_actions %}
<a href="/schedule/{{ order.id }}/csv" class="btn btn-success">导出CSV</a>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">订单信息</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <th>内部型号</th>
                                    <td>{{ order.internal_model or '未设置' }}</td>
                                </tr>
                                <tr>
                                    <th>尺寸 (inch)</th>
                                    <td>{{ "%.2f"|format(order.size or 0) }}</td>
                                </tr>
                                <tr>
                                    <th>出货数量</th>
                                    <td>{{ order.quantity }}</td>
                                </tr>
                                <tr>
                                    <th>预估良率</th>
                                    <td>{{ "%.2f"|format(order.estimated_yield or 100) }}%</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <th>长 (mm)</th>
                                    <td>{{ "%.2f"|format(order.length) }}</td>
                                </tr>
                                <tr>
                                    <th>宽 (mm)</th>
                                    <td>{{ "%.2f"|format(order.width) }}</td>
                                </tr>
                                <tr>
                                    <th>最晚交期</th>
                                    <td>{{ order.due_datetime.strftime('%Y-%m-%d %H:%M') }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">排程统计</div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h5>投入量</h5>
                                    <h3>{{ required_input }}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h5>已分配</h5>
                                    <h3>{{ total_allocated }}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h5>达成率</h5>
                                    <h3>{{ "%.2f"|format(allocated_pct) }}%</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h5>剩余</h5>
                                    <h3>{{ remaining }}</h3>
                                    {% if remaining > 0 %}
                                    <span class="text-danger">未完成</span>
                                    {% else %}
                                    <span class="text-success">已完成</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="progress mb-4" style="height: 30px;">
                        <div class="progress-bar" 
                             role="progressbar" 
                             style="width: {{ min(allocated_pct, 100) }}%" 
                             aria-valuenow="{{ min(allocated_pct, 100) }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            {{ "%.2f"|format(allocated_pct) }}%
                        </div>
                    </div>
                    
                    {% if not meets_due %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>注意：</strong>根据当前产能，无法在最晚交期前完成订单。
                        {% if expected_completion %}
                        预计完成时间: {{ expected_completion.strftime('%Y-%m-%d %H:%M') }}
                        {% endif %}
                        {% if not meets_due_estimate %}
                        即使延长交期也无法保证完成，请考虑增加产能或调整订单量。
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">排程详情</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>开始时间</th>
                                    <th>结束时间</th>
                                    <th>班次</th>
                                    <th>工序</th>
                                    <th>分配数量</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alloc in allocations %}
                                <tr>
                                    <td>{{ alloc.start.strftime('%m-%d %H:%M') }}</td>
                                    <td>{{ alloc.end.strftime('%m-%d %H:%M') }}</td>
                                    <td>
                                        <span class="badge bg-{% if alloc.shift == 'day' %}primary{% elif alloc.shift == 'night' %}dark{% else %}secondary{% endif %}">
                                            {{ alloc.shift }}
                                        </span>
                                    </td>
                                    <td>{{ alloc.operation }}</td>
                                    <td>{{ alloc.allocated }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}